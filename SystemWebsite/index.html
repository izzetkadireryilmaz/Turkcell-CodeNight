<script>
    // --- 1. Türkçe Karakter Düzeltme ve ID Eşleştirme ---
    function normalizeCityName(cityName) {
        if (!cityName) return "";
        let normalized = cityName.toLocaleLowerCase('tr-TR')
            .replace(/ /g, '')
            .replace(/i̇/g, 'i').replace(/ı/g, 'i')
            .replace(/ğ/g, 'g').replace(/ü/g, 'u')
            .replace(/ş/g, 's').replace(/ö/g, 'o')
            .replace(/ç/g, 'c');

        // Harita ID uyuşmazlıkları için manuel düzeltmeler
        if (normalized === 'afyon') return 'afyonkarahisar';
        if (normalized === 'maras') return 'kahramanmaras';
        if (normalized === 'antep') return 'gaziantep';
        if (normalized === 'hakkari') return 'hakkari';
        if (normalized === 'urfa') return 'sanliurfa';
        return normalized;
    }

    // --- 2. Harita Olaylarını Başlatma (Hover vb.) ---
    function initMapEvents() {
        const element = document.querySelector('#svg-turkiye-haritasi');
        const info = document.querySelector('.il-isimleri');

        if (!element) return;

        element.addEventListener('mouseover', function (event) {
            if (event.target.tagName === 'path' && event.target.parentNode.id !== 'guney-kibris') {
                const ilAdi = event.target.parentNode.getAttribute('data-iladi');
                info.innerHTML = '<div>' + ilAdi + '</div>';
            }
        });

        element.addEventListener('mousemove', function (event) {
            info.style.top = event.pageY + 25 + 'px';
            info.style.left = event.pageX + 'px';
        });

        element.addEventListener('mouseout', function (event) {
            info.innerHTML = '';
        });
    }

    // --- 3. Verileri Çekme (AJAX) ---
    async function fetchDisasterData() {
        try {
            // get_map_data.php dosyasını çağırır
            const response = await fetch('get_map_data.php');
            const jsonResponse = await response.json();

            if (jsonResponse.success) {
                // Gelen düz listeyi işle ve haritayı boya
                processAndPaintMap(jsonResponse.data);
            }
        } catch (error) {
            console.error("Veri çekme hatası:", error);
        }
    }

    // --- 4. Veriyi Grupla ve Haritayı Boya (GÜNCELLENEN KISIM) ---
    function processAndPaintMap(flatList) {
        const dataList = document.getElementById('data-list');
        dataList.innerHTML = ''; // Tabloyu temizle

        // Haritadaki eski renkleri sıfırla
        document.querySelectorAll('path').forEach(p => {
            p.classList.remove('Su', 'Yiyecek', 'Barinma', 'Saglik', 'Genel');
            p.style.fill = '';
        });

        // --- A. Veriyi Şehirlere Göre Grupla ---
        // Senin JSON çıktın düz liste olduğu için burada sayım yapıyoruz.
        let cityStats = {};

        flatList.forEach(item => {
            let sehir = item.sehir;
            let kat = item.kategori.toLowerCase(); 

            if (!cityStats[sehir]) {
                cityStats[sehir] = { 
                    toplam: 0, 
                    counts: { su:0, yiyecek:0, barinma:0, saglik:0, genel:0 } 
                };
            }

            cityStats[sehir].toplam++;

            // Kategorileri eşleştir
            if (kat.includes('su')) cityStats[sehir].counts.su++;
            else if (kat.includes('yiyecek') || kat.includes('gıda')) cityStats[sehir].counts.yiyecek++;
            else if (kat.includes('barınma') || kat.includes('çadır') || kat.includes('konaklama')) cityStats[sehir].counts.barinma++;
            else if (kat.includes('sağlık') || kat.includes('ilaç') || kat.includes('doktor')) cityStats[sehir].counts.saglik++;
            else cityStats[sehir].counts.genel++;
        });

        // --- B. Hesaplanan İstatistiklere Göre Haritayı Boya ---
        Object.keys(cityStats).forEach(sehirAdi => {
            const stats = cityStats[sehirAdi];
            
            // En baskın kategoriyi bul
            let dominantCat = 'genel';
            let maxCount = 0;
            
            for (const [key, value] of Object.entries(stats.counts)) {
                if (value > maxCount) {
                    maxCount = value;
                    dominantCat = key;
                }
            }

            // CSS sınıfını belirle
            let cssClass = '';
            if (dominantCat === 'su') cssClass = 'Su';
            else if (dominantCat === 'yiyecek') cssClass = 'Yiyecek';
            else if (dominantKategoriIs('barınma', dominantCat) || dominantCat === 'barinma') cssClass = 'Barinma';
            else if (dominantKategoriIs('sağlık', dominantCat) || dominantCat === 'saglik') cssClass = 'Saglik';
            else cssClass = 'Genel'; // Varsayılan gri renk

            // Haritada ili bul ve boya
            const ilId = normalizeCityName(sehirAdi);
            const cityGroup = document.getElementById(ilId);

            if (cityGroup && cssClass) {
                const paths = cityGroup.querySelectorAll('path');
                paths.forEach(path => path.classList.add(cssClass));
            }

            // Tabloya ekle
            const row = dataList.insertRow();
            row.insertCell(0).innerText = sehirAdi;
            
            const catCell = row.insertCell(1);
            catCell.innerText = dominantCat.toUpperCase();
            catCell.style.fontWeight = "bold";
            
            // Tablo yazı rengi
            if(cssClass === 'Su') catCell.style.color = '#0979e2';
            if(cssClass === 'Yiyecek') catCell.style.color = '#43ef09';
            if(cssClass === 'Barinma') catCell.style.color = '#8f27f1';
            if(cssClass === 'Saglik') catCell.style.color = '#db2808';

            row.insertCell(2).innerText = stats.toplam + " Kayıt"; // Statü yerine toplam sayı
        });
    }
    
    // Yardımcı fonksiyon
    function dominantKategoriIs(target, current) {
        return current.includes(target);
    }

    // --- SİSTEMİ BAŞLAT ---
    initMapEvents();
    fetchDisasterData(); 
    // Her 3 saniyede bir verileri tazele
    setInterval(fetchDisasterData, 3000);

</script>